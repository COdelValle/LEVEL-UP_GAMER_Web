// ====================================
// ADMIN HOME - LEVEL-UP GAMER
// ====================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Admin Panel cargado');
    
    // Verificar autenticaci√≥n
    checkAdminAuth();
    
    // Inicializar dashboard
    initDashboard();
    loadDashboardData();
    
    // Configurar navegaci√≥n
    setupNavigation();
});

// ====================================
// AUTENTICACI√ìN
// ====================================

function checkAdminAuth() {
    const adminSession = JSON.parse(localStorage.getItem('adminSession'));
    
    if (!adminSession || !adminSession.isAuthenticated) {
        // Redirigir al login
        window.location.href = '../admin/home.html';
        return;
    }
    
    // Verificar si la sesi√≥n ha expirado
    const now = new Date().getTime();
    if (now > adminSession.expiresAt) {
        localStorage.removeItem('adminSession');
        showMessage('Sesi√≥n expirada. Por favor inicia sesi√≥n nuevamente.', 'error');
        setTimeout(() => {
            window.location.href = '../login.html';
        }, 2000);
        return;
    }
    
    // Mostrar nombre del admin
    document.getElementById('admin-name').textContent = adminSession.username;
}

function logout() {
    if (confirm('¬øEst√°s seguro que deseas cerrar sesi√≥n?')) {
        localStorage.removeItem('adminSession');
        showMessage('Sesi√≥n cerrada correctamente', 'success');
        setTimeout(() => {
            window.location.href = '../../index.html';
        }, 1000);
    }
}

// ====================================
// NAVEGACI√ìN
// ====================================

function setupNavigation() {
    // Manejar clicks en enlaces de navegaci√≥n
    document.querySelectorAll('.admin-nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            if (this.getAttribute('onclick')) return; // Skip si tiene onclick
            if (this.getAttribute('href').startsWith('http') || this.getAttribute('href').includes('.html')) return;
            
            e.preventDefault();
        });
    });
}

function showSection(sectionName) {
    // Ocultar todas las secciones
    document.querySelectorAll('[id$="-section"]').forEach(section => {
        section.style.display = 'none';
    });
    
    // Mostrar la secci√≥n seleccionada
    const targetSection = document.getElementById(sectionName + '-section');
    if (targetSection) {
        targetSection.style.display = 'block';
    }
    
    // Actualizar navegaci√≥n activa
    document.querySelectorAll('.admin-nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Cargar datos seg√∫n la secci√≥n
    switch(sectionName) {
        case 'products':
            loadProductsData();
            break;
        case 'orders':
            loadOrdersData();
            break;
        case 'users':
            loadUsersData();
            break;
        default:
            document.querySelector('.admin-nav-link').classList.add('active');
    }
}

// ====================================
// DASHBOARD
// ====================================

function initDashboard() {
    // Configurar eventos del dashboard
    loadRecentActivity();
}

function loadDashboardData() {
    // Simular carga de datos del dashboard
    const stats = {
        products: 42,
        orders: 156,
        users: 89,
        revenue: 2450000
    };
    
    // Actualizar estad√≠sticas con animaci√≥n
    animateCounter('total-products', stats.products);
    animateCounter('total-orders', stats.orders);
    animateCounter('total-users', stats.users);
    animateCounterMoney('total-revenue', stats.revenue);
    
    // Cargar productos m√°s vendidos
    loadTopProducts();
}

function animateCounter(elementId, finalValue) {
    const element = document.getElementById(elementId);
    let current = 0;
    const increment = finalValue / 50; // 50 pasos para la animaci√≥n
    
    const timer = setInterval(() => {
        current += increment;
        if (current >= finalValue) {
            current = finalValue;
            clearInterval(timer);
        }
        element.textContent = Math.floor(current);
    }, 30);
}

function animateCounterMoney(elementId, finalValue) {
    const element = document.getElementById(elementId);
    let current = 0;
    const increment = finalValue / 50;
    
    const timer = setInterval(() => {
        current += increment;
        if (current >= finalValue) {
            current = finalValue;
            clearInterval(timer);
        }
        element.textContent = formatPrice(Math.floor(current));
    }, 30);
}

function loadRecentActivity() {
    const activities = [
        {
            action: 'Nuevo pedido #1001',
            time: 'Hace 5 minutos',
            icon: 'üõí'
        },
        {
            action: 'Producto agregado: PlayStation 5',
            time: 'Hace 1 hora',
            icon: 'üì¶'
        },
        {
            action: 'Usuario registrado: gamer123',
            time: 'Hace 2 horas',
            icon: 'üë§'
        },
        {
            action: 'Pedido #998 completado',
            time: 'Hace 3 horas',
            icon: '‚úÖ'
        }
    ];
    
    const container = document.getElementById('recent-activity');
    container.innerHTML = activities.map(activity => `
        <div class="activity-item">
            <div class="d-flex align-items-center">
                <span class="me-2">${activity.icon}</span>
                <div class="flex-grow-1">
                    <div>${activity.action}</div>
                    <div class="activity-time">${activity.time}</div>
                </div>
            </div>
        </div>
    `).join('');
}

function loadTopProducts() {
    const products = [
        {
            id: 1,
            name: 'PlayStation 5',
            category: 'Consolas',
            sales: 45,
            stock: 12,
            status: 'Activo'
        },
        {
            id: 2,
            name: 'Xbox Series X',
            category: 'Consolas',
            sales: 38,
            stock: 8,
            status: 'Activo'
        },
        {
            id: 3,
            name: 'FIFA 24',
            category: 'Juegos',
            sales: 67,
            stock: 25,
            status: 'Activo'
        },
        {
            id: 4,
            name: 'DualSense Controller',
            category: 'Accesorios',
            sales: 89,
            stock: 5,
            status: 'Stock Bajo'
        }
    ];
    
    const tbody = document.getElementById('top-products-table');
    tbody.innerHTML = products.map(product => `
        <tr>
            <td>${product.name}</td>
            <td><span class="category-badge">${product.category}</span></td>
            <td>${product.sales}</td>
            <td>
                <span class="badge ${product.stock < 10 ? 'bg-warning text-dark' : 'bg-success'}">
                    ${product.stock}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary me-1" onclick="editProduct(${product.id})">
                    ‚úèÔ∏è
                </button>
                <button class="btn btn-sm btn-info" onclick="viewProduct(${product.id})">
                    üëÅÔ∏è
                </button>
            </td>
        </tr>
    `).join('');
}

// ====================================
// GESTI√ìN DE PRODUCTOS
// ====================================

function loadProductsData() {
    const products = [
        {
            id: 1,
            name: 'PlayStation 5',
            category: 'Consolas',
            price: 699990,
            stock: 12,
            status: 'Activo'
        },
        {
            id: 2,
            name: 'Xbox Series X',
            category: 'Consolas',
            price: 649990,
            stock: 8,
            status: 'Activo'
        },
        {
            id: 3,
            name: 'Nintendo Switch',
            category: 'Consolas',
            price: 399990,
            stock: 15,
            status: 'Activo'
        },
        {
            id: 4,
            name: 'FIFA 24',
            category: 'Juegos',
            price: 69990,
            stock: 25,
            status: 'Activo'
        },
        {
            id: 5,
            name: 'Call of Duty: Modern Warfare III',
            category: 'Juegos',
            price: 79990,
            stock: 0,
            status: 'Agotado'
        }
    ];
    
    const tbody = document.getElementById('products-table');
    tbody.innerHTML = products.map(product => `
        <tr>
            <td>#${product.id}</td>
            <td>${product.name}</td>
            <td><span class="category-badge">${product.category}</span></td>
            <td>${formatPrice(product.price)}</td>
            <td>
                <span class="badge ${product.stock === 0 ? 'bg-danger' : product.stock < 10 ? 'bg-warning text-dark' : 'bg-success'}">
                    ${product.stock}
                </span>
            </td>
            <td>
                <span class="badge ${product.status === 'Activo' ? 'bg-success' : 'bg-danger'}">
                    ${product.status}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary me-1" onclick="editProduct(${product.id})" title="Editar">
                    ‚úèÔ∏è
                </button>
                <button class="btn btn-sm btn-info me-1" onclick="viewProduct(${product.id})" title="Ver">
                    üëÅÔ∏è
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})" title="Eliminar">
                    üóëÔ∏è
                </button>
            </td>
        </tr>
    `).join('');
}

// ====================================
// GESTI√ìN DE PEDIDOS
// ====================================

function loadOrdersData() {
    const orders = [
        {
            id: 1001,
            customer: 'Juan P√©rez',
            date: '2024-03-15',
            total: 699990,
            status: 'Pendiente'
        },
        {
            id: 1000,
            customer: 'Mar√≠a Gonz√°lez',
            date: '2024-03-15',
            total: 149980,
            status: 'Enviado'
        },
        {
            id: 999,
            customer: 'Carlos L√≥pez',
            date: '2024-03-14',
            total: 399990,
            status: 'Entregado'
        },
        {
            id: 998,
            customer: 'Ana Mart√≠nez',
            date: '2024-03-14',
            total: 79990,
            status: 'Completado'
        }
    ];
    
    const tbody = document.getElementById('orders-table');
    tbody.innerHTML = orders.map(order => `
        <tr>
            <td>#${order.id}</td>
            <td>${order.customer}</td>
            <td>${formatDate(order.date)}</td>
            <td>${formatPrice(order.total)}</td>
            <td>
                <span class="badge ${getOrderStatusClass(order.status)}">
                    ${order.status}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary me-1" onclick="viewOrder(${order.id})" title="Ver Detalles">
                    üëÅÔ∏è
                </button>
                <button class="btn btn-sm btn-success me-1" onclick="updateOrderStatus(${order.id})" title="Actualizar Estado">
                    üìù
                </button>
            </td>
        </tr>
    `).join('');
}

function getOrderStatusClass(status) {
    switch(status) {
        case 'Pendiente': return 'bg-warning text-dark';
        case 'Enviado': return 'bg-info';
        case 'Entregado': return 'bg-success';
        case 'Completado': return 'bg-primary';
        default: return 'bg-secondary';
    }
}

// ====================================
// GESTI√ìN DE USUARIOS
// ====================================

function loadUsersData() {
    const users = [
        {
            id: 1,
            name: 'Juan P√©rez',
            email: 'juan@email.com',
            registrationDate: '2024-01-15',
            status: 'Activo'
        },
        {
            id: 2,
            name: 'Mar√≠a Gonz√°lez',
            email: 'maria@email.com',
            registrationDate: '2024-02-10',
            status: 'Activo'
        },
        {
            id: 3,
            name: 'Carlos L√≥pez',
            email: 'carlos@email.com',
            registrationDate: '2024-02-28',
            status: 'Inactivo'
        },
        {
            id: 4,
            name: 'Ana Mart√≠nez',
            email: 'ana@email.com',
            registrationDate: '2024-03-05',
            status: 'Activo'
        }
    ];
    
    const tbody = document.getElementById('users-table');
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>#${user.id}</td>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${formatDate(user.registrationDate)}</td>
            <td>
                <span class="badge ${user.status === 'Activo' ? 'bg-success' : 'bg-secondary'}">
                    ${user.status}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-info me-1" onclick="viewUser(${user.id})" title="Ver">
                    üëÅÔ∏è
                </button>
                <button class="btn btn-sm btn-primary me-1" onclick="editUser(${user.id})" title="Editar">
                    ‚úèÔ∏è
                </button>
                <button class="btn btn-sm ${user.status === 'Activo' ? 'btn-warning' : 'btn-success'}" onclick="toggleUserStatus(${user.id})" title="${user.status === 'Activo' ? 'Desactivar' : 'Activar'}">
                    ${user.status === 'Activo' ? 'üîí' : 'üîì'}
                </button>
            </td>
        </tr>
    `).join('');
}

// ====================================
// ACCIONES DE PRODUCTOS
// ====================================

function editProduct(id) {
    showMessage(`Editando producto #${id}`, 'info');
    // Aqu√≠ ir√≠a la l√≥gica para editar el producto
    // Por ahora solo mostramos un mensaje
}

function viewProduct(id) {
    showMessage(`Viendo detalles del producto #${id}`, 'info');
    // Aqu√≠ ir√≠a la l√≥gica para ver el producto
}

function deleteProduct(id) {
    if (confirm(`¬øEst√°s seguro de eliminar el producto #${id}?`)) {
        showMessage(`Producto #${id} eliminado correctamente`, 'success');
        // Aqu√≠ ir√≠a la l√≥gica para eliminar el producto
        setTimeout(() => {
            loadProductsData(); // Recargar datos
        }, 1000);
    }
}

// ====================================
// ACCIONES DE PEDIDOS
// ====================================

function viewOrder(id) {
    showMessage(`Viendo detalles del pedido #${id}`, 'info');
    // Aqu√≠ ir√≠a la l√≥gica para ver detalles del pedido
}

function updateOrderStatus(id) {
    const newStatus = prompt('Nuevo estado del pedido:', 'Enviado');
    if (newStatus) {
        showMessage(`Estado del pedido #${id} actualizado a: ${newStatus}`, 'success');
        // Aqu√≠ ir√≠a la l√≥gica para actualizar el estado
        setTimeout(() => {
            loadOrdersData(); // Recargar datos
        }, 1000);
    }
}

// ====================================
// ACCIONES DE USUARIOS
// ====================================

function viewUser(id) {
    showMessage(`Viendo detalles del usuario #${id}`, 'info');
    // Aqu√≠ ir√≠a la l√≥gica para ver el usuario
}

function editUser(id) {
    showMessage(`Editando usuario #${id}`, 'info');
    // Aqu√≠ ir√≠a la l√≥gica para editar el usuario
}

function toggleUserStatus(id) {
    if (confirm(`¬øCambiar el estado del usuario #${id}?`)) {
        showMessage(`Estado del usuario #${id} actualizado correctamente`, 'success');
        // Aqu√≠ ir√≠a la l√≥gica para cambiar el estado
        setTimeout(() => {
            loadUsersData(); // Recargar datos
        }, 1000);
    }
}

// ====================================
// UTILIDADES
// ====================================

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('es-CL', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function formatPrice(price) {
    return new Intl.NumberFormat('es-CL', {
        style: 'currency',
        currency: 'CLP',
        minimumFractionDigits: 0
    }).format(price);
}

function generateReport() {
    showMessage('Generando reporte...', 'info');
    
    // Simular generaci√≥n de reporte
    setTimeout(() => {
        showMessage('Reporte generado correctamente', 'success');
        
        // Crear y descargar un archivo de ejemplo
        const reportData = {
            fecha: new Date().toLocaleDateString('es-CL'),
            productos: 42,
            pedidos: 156,
            usuarios: 89,
            ingresos: 2450000
        };
        
        const reportContent = `
REPORTE LEVEL-UP GAMER
=====================
Fecha: ${reportData.fecha}

RESUMEN GENERAL:
- Total Productos: ${reportData.productos}
- Total Pedidos: ${reportData.pedidos}
- Total Usuarios: ${reportData.usuarios}
- Ingresos Totales: ${formatPrice(reportData.ingresos)}

PRODUCTOS M√ÅS VENDIDOS:
1. PlayStation 5 - 45 ventas
2. Xbox Series X - 38 ventas
3. FIFA 24 - 67 ventas
4. DualSense Controller - 89 ventas

ESTADO DE PEDIDOS:
- Pendientes: 12
- Enviados: 8
- Entregados: 136

Generado autom√°ticamente por Level-Up Gamer Admin Panel
        `;
        
        downloadReport(reportContent, 'reporte-levelup-gamer.txt');
    }, 2000);
}

function downloadReport(content, filename) {
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

// ====================================
// SISTEMA DE MENSAJES
// ====================================

function showMessage(message, type = 'info') {
    // Crear elemento de mensaje
    const messageEl = document.createElement('div');
    messageEl.className = `message message-${type}`;
    messageEl.textContent = message;
    
    // Estilos del mensaje
    messageEl.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 600;
        z-index: 9999;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        max-width: 300px;
    `;
    
    // Colores seg√∫n tipo
    switch(type) {
        case 'success':
            messageEl.style.background = 'linear-gradient(135deg, #39FF14, #1E90FF)';
            break;
        case 'error':
            messageEl.style.background = 'linear-gradient(135deg, #ff4444, #cc0000)';
            break;
        case 'warning':
            messageEl.style.background = 'linear-gradient(135deg, #ffaa00, #ff7700)';
            break;
        default:
            messageEl.style.background = 'linear-gradient(135deg, #1E90FF, #39FF14)';
    }
    
    // A√±adir al DOM
    document.body.appendChild(messageEl);
    
    // Animar entrada
    setTimeout(() => {
        messageEl.style.transform = 'translateX(0)';
    }, 100);
    
    // Remover despu√©s de 3 segundos
    setTimeout(() => {
        messageEl.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(messageEl)) {
                document.body.removeChild(messageEl);
            }
        }, 300);
    }, 3000);
}